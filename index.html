<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>西武列車情報検索ツール（遅れ・時刻・番線・運転整理・車両形式＋運行情報）</title>
<style>
  body { font-family: sans-serif; margin: 20px; }
  h2 { margin-top: 0; }
  #operationInfo {
    border: 1px solid #888;
    padding: 8px;
    background: #f0f8ff;
    margin-bottom: 12px;
    font-size: 14px;
  }
  #searchArea {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 12px;
  }
  #searchArea label {
    display: inline-block;
    width: 80px;
  }
  #searchArea input[type="text"] {
    width: 160px;
  }
  #resultPanel {
    border: 1px solid #888;
    padding: 8px;
    margin-bottom: 10px;
  }
  #resultPanel h3 {
    margin: 0 0 4px 0;
    font-size: 15px;
  }
  #resultPanel table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 4px;
  }
  #resultPanel th,
  #resultPanel td {
    border: 1px solid #ccc;
    padding: 4px 6px;
    font-size: 13px;
    text-align: left;
  }
  #log {
    font-size: 11px;
    background:#f5f5f5;
    padding:6px;
    border:1px solid #ccc;
    white-space:pre-wrap;
    max-height:220px;
    overflow:auto;
  }
</style>
</head>
<body>
<h2>西武列車情報検索ツール</h2>

<div id="operationInfo">
  <strong>運行情報：</strong>
  <span id="operationText">取得中...</span>
  <div id="operationMeta" style="font-size:12px;color:#555;"></div>
</div>

<div id="searchArea">
  <div style="margin-bottom:6px;">
    <label for="lineSelect">路線：</label>
    <select id="lineSelect"></select>
  </div>
  <div style="margin-bottom:6px;">
    <label for="stationInput">駅名：</label>
    <input type="text" id="stationInput" placeholder="例：池袋">
    <span style="font-size:11px;color:#666;">※路線内の駅名と一致させてください</span>
  </div>
  <div style="margin-bottom:6px;">
    <label for="trainNoInput">列車番号：</label>
    <input type="text" id="trainNoInput" placeholder="例：5543">
  </div>
  <button id="searchBtn">検索</button>
</div>

<div id="resultPanel">
  <h3>検索結果</h3>
  <div id="resultContent">まだ検索されていません。</div>
</div>

<pre id="log"></pre>

<!-- 路線・駅一覧（routes 変数） -->
<script src="routes_es5.js"></script>

<script>
// ==================== 共通ログ ====================
function log(msg){
  var el = document.getElementById("log");
  var time = new Date().toLocaleTimeString();
  el.textContent += "[" + time + "] " + msg + "\n";
  el.scrollTop = el.scrollHeight;
}

// ==================== 運転整理コード → 説明 ====================
// ユーザーさんが教えてくれたビット列と意味を、そのままマッピング。
// それ以外のコードは「不明（コード: ...）」として表示。
function decodeOperationOrganize(code) {
  if (!code) return "（情報なし）";
  var map = {
    "00000000000000010000000000000010": "臨時停車・通過／着発線変更",
    "00000000000000000000000000000001": "接続変更",
    "00000000000000000000000000000100": "順序変更",
    "00000000000000000000000000000011": "着発線変更／接続変更",
    "00000000000000001000000000000000": "車交変更"
  };
  if (map[code]) return map[code] + "（運転整理）";
  return "不明（運転整理コード: " + code + "）";
}

// ==================== routes まわり ====================
function getRouteById(id) {
  if (!window.routes || !routes.length) return null;
  for (var i = 0; i < routes.length; i++) {
    if (routes[i].id === id) return routes[i];
  }
  return null;
}

// 路線内の駅名 → 駅オブジェクト
function findStationByName(route, name) {
  if (!route || !route.stations) return null;
  var target = String(name || "").replace(/\s+/g, "");
  for (var i = 0; i < route.stations.length; i++) {
    var s = route.stations[i];
    var sname = String(s.name || "").replace(/\s+/g, "");
    if (sname === target) return s;
  }
  return null;
}

// ==================== 運行情報取得 ====================
function fetchOperationInfo() {
  var url = "https://train.seibuapp.jp/trainfo-api/ti/v1.0/lines/all/status";
  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function(){
    if (xhr.readyState === 4) {
      var textEl = document.getElementById("operationText");
      var metaEl = document.getElementById("operationMeta");
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          var json = JSON.parse(xhr.responseText || "{}");
          var list = json.lineStatus || json.lines || [];
          if (list.length > 0) {
            var st = list[0];
            var detail = st.operationDetail || st.operation || "情報取得に失敗しました。";
            textEl.textContent = detail;
            metaEl.textContent = "status=" + (st.status || "不明") +
                                 " / lineId=" + (st.lineId || "all") +
                                 " / 更新時刻: " + new Date().toLocaleTimeString();
          } else {
            textEl.textContent = "運行情報が取得できませんでした。";
            metaEl.textContent = "";
          }
        } catch(e) {
          textEl.textContent = "運行情報 JSON パースエラー: " + e.message;
          metaEl.textContent = "";
        }
      } else {
        textEl.textContent = "運行情報 APIエラー: HTTP " + xhr.status;
        metaEl.textContent = "";
      }
    }
  };
  xhr.onerror = function(e){
    var textEl = document.getElementById("operationText");
    var metaEl = document.getElementById("operationMeta");
    textEl.textContent = "運行情報 XHRエラー: " +
                         (e && e.message ? e.message : "不明");
    metaEl.textContent = "";
  };
  xhr.send(null);
}

// ==================== 列車一覧取得（最優先 API） ====================
function fetchTrainsByLine(lineId, callback) {
  var url = "https://train.seibuapp.jp/trainfo-api/ti/v1.0/trains?lineId=" +
            encodeURIComponent(lineId);
  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function(){
    if (xhr.readyState === 4) {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          var json = JSON.parse(xhr.responseText || "{}");
          var trains = json.train || json.trains || [];
          log("列車一覧取得: lineId=" + lineId + " 件数=" + trains.length);
          callback(trains);
        } catch(e) {
          log("列車一覧 JSON パースエラー: " + e.message);
          callback([]);
        }
      } else {
        log("列車一覧 APIエラー: HTTP " + xhr.status + " lineId=" + lineId);
        callback([]);
      }
    }
  };
  xhr.onerror = function(e){
    log("列車一覧 XHRエラー: " +
        (e && e.message ? e.message : "不明") +
        " lineId=" + lineId);
    callback([]);
  };
  xhr.send(null);
}

// ==================== 駅別発車情報取得（departures 展開・修正版） ====================
function fetchStationDeparturesFlatten(stationId, callback) {
  var url = "https://train.seibuapp.jp/trainfo-api/ti/v1.0/stations/" +
            encodeURIComponent(stationId) + "/departures";

  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          var text = xhr.responseText || "";

          // ★レスポンスの一部とトップレベルのキーをログ
          log("駅別発車情報レスポンス(一部) stationId=" + stationId + " : " +
              text.substr(0, 200).replace(/\s+/g, " ") +
              (text.length > 200 ? "..." : ""));

          var json = JSON.parse(text);
          var rootList = [];

          // --- トップレベルの配列候補 ---
          if (Array.isArray(json)) {
            rootList = json;
          } else if (json.departure && Array.isArray(json.departure)) {
            // 例: { total: .., offset: 0, departure: [ {...}, {...} ] }
            rootList = json.departure;
          } else if (json.departures && Array.isArray(json.departures)) {
            rootList = json.departures;
          } else if (json.list && Array.isArray(json.list)) {
            rootList = json.list;
          } else if (json.data && Array.isArray(json.data)) {
            rootList = json.data;
          }

          // --- 展開 ---
          var flat = [];

          for (var i = 0; i < rootList.length; i++) {
            var top = rootList[i] || {};
            var detail = top.detail;
            var baseStationId = top.stationId || stationId;
            var baseLineId = top.lineId || null;
            var baseDirectionName = top.directionName || null;
            var baseSectionNo = top.sectionNo;

            var subList = [];

            // detail の中にある配列候補を総当り
            if (detail) {
              if (detail.departureList && Array.isArray(detail.departureList)) {
                subList = detail.departureList;
              } else if (detail.departure && Array.isArray(detail.departure)) {
                // おそらくこちらが本命
                subList = detail.departure;
              } else if (detail.list && Array.isArray(detail.list)) {
                subList = detail.list;
              }
            }

            if (subList.length > 0) {
              for (var j = 0; j < subList.length; j++) {
                var d = subList[j] || {};
                var obj = {};
                var key;

                // detail 側の要素をコピー
                for (key in d) {
                  if (d.hasOwnProperty(key)) {
                    obj[key] = d[key];
                  }
                }

                // 上位の stationId / lineId / directionName / sectionNo を補完
                if (baseStationId != null) obj.stationId = baseStationId;
                if (baseLineId   != null) obj.lineId    = baseLineId;
                if (baseDirectionName != null) obj.directionName = baseDirectionName;
                if (baseSectionNo != null) obj.sectionNo = baseSectionNo;

                flat.push(obj);
              }
            } else {
              // detail 側に配列がない場合、
              // もし top 自体が trainNo, departureTime 等を持っていれば
              // それを 1 レコードとして扱うフォールバック
              if (top.trainNo != null || top.departureTime != null) {
                var obj2 = {};
                var kk;
                for (kk in top) {
                  if (top.hasOwnProperty(kk) && kk !== "detail") {
                    obj2[kk] = top[kk];
                  }
                }
                if (baseStationId != null) obj2.stationId = baseStationId;
                if (baseLineId   != null) obj2.lineId    = baseLineId;
                if (baseDirectionName != null) obj2.directionName = baseDirectionName;
                if (baseSectionNo != null) obj2.sectionNo = baseSectionNo;

                flat.push(obj2);
              }
            }
          }

          if (flat.length > 0) {
            log("駅別発車情報(展開後)件数=" + flat.length +
                " stationId=" + stationId +
                " 先頭要素キー=" + Object.keys(flat[0]).join(","));
          } else {
            log("駅別発車情報(展開後): 配列が空 stationId=" + stationId);
          }

          callback(flat);
        } catch(e) {
          log("駅別発車情報 JSON パースエラー: " + e.message +
              " stationId=" + stationId);
          callback([]);
        }
      } else {
        log("駅別発車情報 APIエラー: HTTP " + xhr.status +
            " stationId=" + stationId);
        callback([]);
      }
    }
  };

  xhr.onerror = function(e){
    log("駅別発車情報 XHRエラー: " +
        (e && e.message ? e.message : "不明") +
        " stationId=" + stationId);
    callback([]);
  };

  xhr.send(null);
}

// ==================== 検索ロジック ====================
function runSearch() {
  var lineSel = document.getElementById("lineSelect");
  var lineId = lineSel.value;
  var route = getRouteById(lineId);

  var stationName = document.getElementById("stationInput").value || "";
  var trainNoInput = document.getElementById("trainNoInput").value || "";
  var trainNo = trainNoInput.replace(/\s+/g, "");

  var resultEl = document.getElementById("resultContent");

  if (!route) {
    alert("路線情報が取得できていません（routes_es5.js を確認してください）。");
    return;
  }
  if (!stationName) {
    alert("駅名を入力してください。");
    return;
  }
  if (!trainNo) {
    alert("列車番号を入力してください。");
    return;
  }

  var st = findStationByName(route, stationName);
  if (!st) {
    alert("指定した路線内に、駅名「" + stationName + "」が見つかりませんでした。");
    return;
  }

  log("検索開始: lineId=" + lineId +
      " / 駅=" + st.name + "(" + st.id + ")" +
      " / 列車番号=" + trainNo);

  resultEl.textContent = "検索中...";

  // 1. まず trains?lineId=... で、該当列車を探す（最優先）
  fetchTrainsByLine(lineId, function(trains) {
    var targetTrain = null;
    for (var i = 0; i < trains.length; i++) {
      var t = trains[i];
      var no = String(t.trainNo != null ? t.trainNo : "").replace(/\s+/g, "");
      if (no === trainNo) {
        targetTrain = t;
        break;
      }
    }

    if (!targetTrain) {
      log("列車番号 " + trainNo + " は lineId=" + lineId + " で見つかりませんでした。");
    } else {
      log("列車番号 " + trainNo + " の情報を trains API から取得しました。");
    }

    // 2. 駅別発車情報から、発車時刻・番線・車両形式などを探す
    fetchStationDeparturesFlatten(st.id, function(deps) {

      var depRow = null;
      // 指定列車番号と lineId が一致する行を探す
      for (var i = 0; i < deps.length; i++) {
        var d = deps[i];
        var dTrainNo = String(d.trainNo != null ? d.trainNo : "").replace(/\s+/g, "");
        var dLineId  = d.lineId || null;
        if (dTrainNo === trainNo && (!dLineId || dLineId === lineId)) {
          depRow = d;
          break;
        }
      }

      if (!depRow) {
        log("駅別発車情報には、列車番号 " + trainNo +
            " のデータが見つかりませんでした（駅=" + st.id + "）。");
      } else {
        log("駅 " + st.id + " で列車 " + trainNo + " の発車情報を検出しました。");
      }

      // 3. 両方の情報をマージして結果に反映
      var delayFromTrain = null;
      if (targetTrain) {
        if (targetTrain.delay != null) delayFromTrain = targetTrain.delay;
        else if (targetTrain.late != null) delayFromTrain = targetTrain.late;
        else if (targetTrain.lateness != null) delayFromTrain = targetTrain.lateness;
      }

      var delayFromDep = null;
      if (depRow) {
        if (depRow.delay != null) delayFromDep = depRow.delay;
        else if (depRow.late != null) delayFromDep = depRow.late;
        else if (depRow.lateness != null) delayFromDep = depRow.lateness;
      }

      var delayText = "";
      if (delayFromTrain != null) {
        delayText = delayFromTrain + "分";
      } else if (delayFromDep != null) {
        delayText = delayFromDep + "分";
      } else {
        delayText = "（情報なし）";
      }

      // 発車時刻・番線・車両形式
      var depTime = depRow && depRow.departureTime ? depRow.departureTime : "";
      var platform = depRow && depRow.platform ? depRow.platform : "";
      var carType = "";

      if (targetTrain && (targetTrain.carTypeName || targetTrain.carType)) {
        carType = targetTrain.carTypeName || targetTrain.carType;
      } else if (depRow && (depRow.carTypeForSignage || depRow.carType)) {
        carType = depRow.carTypeForSignage || depRow.carType;
      }

      if (!depTime) depTime = "（情報なし）";
      if (!platform) platform = "（情報なし）";
      if (!carType) carType = "（情報なし）";

      // 運転整理情報（operationOrganize）
      var opeCode = targetTrain && targetTrain.operationOrganize ?
                    targetTrain.operationOrganize : null;
      var opeText = decodeOperationOrganize(opeCode);

      // 種別・行先など（補足）
      var trainType =
        targetTrain ?
          (targetTrain.trainTypeName || targetTrain.trainType || "（不明）") :
          (depRow ? (depRow.trainType || "（不明）") : "（不明）");

      var destName =
        targetTrain ?
          (targetTrain.endStationName || targetTrain.destination || "") :
          (depRow ? (depRow.destination || "") : "");

      if (!destName) destName = "（不明）";

      // 4. 結果表示
      var html = "";
      html += "<table>";
      html += "<tr><th>路線</th><td>" +
              (route.name || "") + " (" + route.id + ")</td></tr>";
      html += "<tr><th>駅</th><td>" +
              st.name + " (" + st.id + ")</td></tr>";
      html += "<tr><th>列車番号</th><td>" + trainNo + "</td></tr>";
      html += "<tr><th>種別</th><td>" + trainType + "</td></tr>";
      html += "<tr><th>行先</th><td>" + destName + "</td></tr>";
      html += "<tr><th>現在の遅れ</th><td>" + delayText + "</td></tr>";
      html += "<tr><th>この駅の発車時刻</th><td>" + depTime + "</td></tr>";
      html += "<tr><th>発車番線</th><td>" + platform + "</td></tr>";
      html += "<tr><th>車両形式</th><td>" + carType + "</td></tr>";
      html += "<tr><th>運転整理情報</th><td>" + opeText + "</td></tr>";
      html += "</table>";

      // 補足（どこから何を取ったか）
      html += "<div style='margin-top:6px;font-size:11px;color:#555;'>";
      html += "※遅れ・運転整理・車両形式は <code>trains?lineId=...</code> の情報を優先し、";
      html += "発車時刻・番線・駅別の車両情報は <code>stations/{stationId}/departures</code> から取得しています。";
      html += "</div>";

      resultEl.innerHTML = html;
    });
  });
}

// ==================== 初期化 ====================
window.onload = function() {
  if (typeof routes === "undefined" || !routes || !routes.length) {
    log("エラー: routes_es5.js が読み込めていないか、routes が空です。");
    alert("routes_es5.js が読み込めていません。HTML と同じフォルダに配置してください。");
    return;
  }

  // 路線セレクト初期化
  var sel = document.getElementById("lineSelect");
  sel.innerHTML = "";
  for (var i = 0; i < routes.length; i++) {
    var r = routes[i];
    var opt = document.createElement("option");
    opt.value = r.id;
    opt.text  = r.name + " (" + r.id + ")";
    sel.appendChild(opt);
  }
  if (routes.length) sel.value = routes[0].id;

  document.getElementById("searchBtn").onclick = runSearch;

  // Enter キーでも検索できるように
  document.getElementById("trainNoInput").addEventListener("keyup", function(e){
    if (e.keyCode === 13) runSearch();
  });
  document.getElementById("stationInput").addEventListener("keyup", function(e){
    if (e.keyCode === 13) runSearch();
  });

  // 運行情報の初回取得＋定期更新（60秒ごと）
  fetchOperationInfo();
  setInterval(fetchOperationInfo, 60000);

  log("初期化完了。路線数=" + routes.length);
};
</script>
</body>
</html>