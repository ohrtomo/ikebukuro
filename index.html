<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>東村山駅 50m 音声通知デモ</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Kaku Gothic ProN','Noto Sans JP',sans-serif;margin:1.5rem}
    button{padding:.6rem 1rem;border-radius:8px;border:1px solid #ccc;background:#fff}
    .on{background:#e6ffed;border-color:#7bd389}
    .off{background:#fff;border-color:#ccc}
    .status{margin-top:1rem;padding:1rem;border-radius:8px;background:#f7f7f7}
  </style>
</head>
<body>
  <h1>東村山駅から50m以内で音声通知するデモ</h1>
  <p>ブラウザの位置情報を使います（HTTPSまたはlocalhostで実行）。</p>

  <div>
    <button id="startBtn" class="off">位置監視を開始</button>
    <button id="stopBtn" class="off" disabled>停止</button>
  </div>

  <div class="status" id="status">
    <div><strong>現在位置:</strong> <span id="coords">—</span></div>
    <div><strong>東村山駅までの距離:</strong> <span id="distance">—</span> m</div>
    <div><strong>最終お知らせ:</strong> <span id="lastNotified">まだありません</span></div>
  </div>

  <script>
    // 東村山駅中心座標
    const target = { lat: 35.76056, lon: 139.46583 };
    const RADIUS_METERS = 50;

    let watchId = null;
    let hasNotified = false;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const coordsEl = document.getElementById('coords');
    const distanceEl = document.getElementById('distance');
    const lastNotifiedEl = document.getElementById('lastNotified');

    function haversineDistance(lat1, lon1, lat2, lon2) {
      const toRad = x => x * Math.PI / 180;
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function speak(text) {
      if ('speechSynthesis' in window) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ja-JP';
        speechSynthesis.speak(utter);
      } else {
        alert(text); // フォールバック
      }
    }

    function handlePosition(pos) {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      coordsEl.textContent = lat.toFixed(6) + ', ' + lon.toFixed(6);
      const d = Math.round(haversineDistance(lat, lon, target.lat, target.lon));
      distanceEl.textContent = d;

      if (d <= RADIUS_METERS) {
        if (!hasNotified) {
          hasNotified = true;
          speak(`東村山駅に近づいています。駅中心から${RADIUS_METERS}メートル以内です。`);
          lastNotifiedEl.textContent = new Date().toLocaleString();
        }
      } else {
        if (hasNotified && d > RADIUS_METERS + 10) {
          hasNotified = false;
        }
      }
    }

    function handleError(err) {
      console.error(err);
      alert('位置情報の取得でエラー: ' + err.message);
    }

    startBtn.addEventListener('click', () => {
      if (!('geolocation' in navigator)) {
        alert('このブラウザは位置情報に対応していません');
        return;
      }

      if (watchId !== null) return;
      watchId = navigator.geolocation.watchPosition(handlePosition, handleError, {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000
      });

      startBtn.disabled = true;
      startBtn.className = 'on';
      stopBtn.disabled = false;
    });

    stopBtn.addEventListener('click', () => {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      startBtn.disabled = false;
      startBtn.className = 'off';
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
